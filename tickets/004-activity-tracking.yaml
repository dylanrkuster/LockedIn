id: '004'
type: feature
title: Activity Tracking and Balance System (Core Loop)
priority: P1
complexity: large

po_notes: |
  - Completes the core loop: Earn → Spend → Block → Workout.
  - This is where the app becomes REAL. Mock data → live data.
  - Activity feed builds user trust—they can see the math working.
  - Real-time feel is critical. Not batched. Not delayed. Live.
  - Per-app granularity on spend side. Users should see "Instagram -12" not "Screen Time -45".

description: |
  The Activity section shows mock data. Balance never changes.
  Users can't see what they earned from workouts or spent on apps.
  The core value proposition—workout to earn screen time—is non-functional.

  After this ticket: users see their balance change in real-time as they
  use blocked apps, and see it increase when workouts complete.

# ═══════════════════════════════════════════════════════════════════
# EARNING BEHAVIOR (Workouts → Balance)
# ═══════════════════════════════════════════════════════════════════

earning_behavior: |
  **Trigger:** Any workout recorded in Apple Health.

  **Timing:** Balance updates as soon as possible after workout completion.
  When the user finishes a workout and it syncs to Health, the earned
  minutes should appear in LockedIn without requiring manual refresh.
  Background observer should catch workouts even when app is closed.

  **Calculation:**
  ```
  earned_minutes = floor(workout_duration_minutes × difficulty_multiplier)
  ```

  | Difficulty | Multiplier | 30min workout earns |
  |------------|------------|---------------------|
  | Easy       | 2.0        | 60 min              |
  | Medium     | 1.0        | 30 min              |
  | Hard       | 0.5        | 15 min              |
  | Extreme    | 0.33       | 10 min              |

  **Cap behavior:** If earning would exceed the difficulty's max balance,
  only earn up to the cap. Excess is forfeited (no rollover, no banking).

  | Difficulty | Max Balance |
  |------------|-------------|
  | Easy       | 240 min     |
  | Medium     | 180 min     |
  | Hard       | 120 min     |
  | Extreme    | 60 min      |

  **Duplicate prevention:** Each workout (by unique ID) is only counted once.
  Re-syncing Health data or relaunching the app does not double-count.

  **Transaction created:**
  - Amount: +[earned minutes]
  - Source: Workout type name (e.g., "Run", "HIIT", "Strength", "Walk")
  - Timestamp: Workout end time

  **Workout type display names:**
  - Running → "Run"
  - Walking → "Walk"
  - Cycling → "Cycling"
  - Functional Strength Training → "Strength"
  - Traditional Strength Training → "Strength"
  - High Intensity Interval Training → "HIIT"
  - Yoga → "Yoga"
  - Swimming → "Swim"
  - All others → "Workout"

# ═══════════════════════════════════════════════════════════════════
# SPENDING BEHAVIOR (App Usage → Balance)
# ═══════════════════════════════════════════════════════════════════

spending_behavior: |
  **Trigger:** User uses any app in their blocked list.

  **Timing:** Balance decrements in real-time as the user spends time
  in blocked apps. This should feel live, not batched or delayed.

  **Calculation:**
  ```
  spent_minutes = actual_minutes_in_blocked_app
  ```
  Spending is always 1:1 regardless of difficulty. One minute in Instagram
  costs one minute from the bank.

  **Per-app granularity:** Each blocked app used creates its own transaction.
  If user spends 12 min on Instagram and 8 min on TikTok, Activity shows:
  ```
  -12  Instagram    2:45pm
  -8   TikTok       2:30pm
  ```
  NOT a single "-20 Screen Time" entry.

  **Transaction created:**
  - Amount: -[minutes spent]
  - Source: App name (as provided by FamilyControls/DeviceActivity)
  - Timestamp: When the usage session started (or ended, be consistent)

  **Zero balance:** When balance hits 0, shield activates immediately.
  The final spend transaction should reflect actual minutes spent before
  hitting zero, not overshoot into negative.

# ═══════════════════════════════════════════════════════════════════
# ACTIVITY DISPLAY
# ═══════════════════════════════════════════════════════════════════

activity_display: |
  **What's shown:** The 8 most recent transactions.

  **Sort order:** Most recent first (descending by timestamp).

  **Each row displays:**
  - Signed amount: "+15" (green/accent) or "-12" (gray)
  - Source name: "Run", "Instagram", "HIIT", "TikTok", etc.
  - Timestamp: "7:33pm" for today, "1/2 7:33pm" for older dates

  **Retention:** Transactions older than 7 days are automatically purged.
  Users don't see ancient history.

  **Empty state:** If no transactions exist, show "No activity yet".

# ═══════════════════════════════════════════════════════════════════
# PERSISTENCE
# ═══════════════════════════════════════════════════════════════════

persistence: |
  **Balance:** Persists across app launches and device restarts.

  **Transactions:** Persist across app launches. 7-day rolling window.

  **Processed workouts:** Track which workouts have been counted to
  prevent double-counting on re-sync.

  **Cross-process:** Balance and transaction data must be accessible
  by both the main app and any extensions (for real-time updates).

# ═══════════════════════════════════════════════════════════════════
# AUTHORIZATION
# ═══════════════════════════════════════════════════════════════════

authorization: |
  **HealthKit permission:** Required to read workouts.

  - Prompt user on first launch (or when first attempting to earn)
  - If denied: App still functions, but earning is disabled. User can
    only spend down their starting balance until they grant permission.
  - Include clear usage description explaining why we need Health access

# ═══════════════════════════════════════════════════════════════════
# ACCEPTANCE CRITERIA
# ═══════════════════════════════════════════════════════════════════

acceptance_criteria:
  # Earning
  - Completing a workout in Apple Health adds earned minutes to balance
  - Earned minutes respect difficulty ratio (Hard 2:1 = 30min workout → +15)
  - Balance cannot exceed difficulty cap (excess forfeited)
  - Same workout synced twice is only counted once
  - Workout transaction shows workout type name, not generic "Workout"
  - Balance updates without manual refresh (background observer)

  # Spending
  - Using a blocked app decrements balance in real-time
  - Each blocked app creates its own transaction with app name
  - Spending is 1:1 (10 min on TikTok = -10 from balance)
  - Balance stops at 0 (no negative balance)
  - Shield activates immediately when balance hits 0

  # Activity Display
  - Activity section shows real transactions, not mock data
  - Shows 8 most recent transactions
  - Sorted by timestamp, most recent first
  - Transactions older than 7 days are not shown

  # Persistence
  - Balance persists across app launches
  - Transactions persist across app launches
  - Workouts are not double-counted after app restart

  # Authorization
  - HealthKit permission requested appropriately
  - App functions (spend-only) if HealthKit denied

# ═══════════════════════════════════════════════════════════════════
# TEST SCENARIOS
# ═══════════════════════════════════════════════════════════════════

test_scenarios:
  earning:
    - "Complete 30min run on Medium: Activity shows '+30 Run', balance increases by 30"
    - "Complete 60min strength on Hard: Activity shows '+30 Strength', balance increases by 30"
    - "Complete 30min yoga on Easy: Activity shows '+60 Yoga', balance increases by 60"
    - "Balance at 110/120 (Hard), complete 60min workout: Balance goes to 120, not 140"
    - "Complete workout, kill app, reopen: Balance still reflects earned minutes"
    - "Same workout appears twice in Health: Only one transaction created"

  spending:
    - "Use Instagram for 10 minutes: Activity shows '-10 Instagram'"
    - "Use TikTok for 5 min then Instagram for 8 min: Two separate transactions"
    - "Balance at 3, use app for 10 min: Balance goes to 0, transaction shows -3"
    - "Kill app while using blocked app, reopen: Balance reflects time spent"

  activity_display:
    - "12 transactions exist: Only 8 most recent shown"
    - "Transaction from 8 days ago: Not visible in Activity"
    - "Mix of earn and spend: Both types appear correctly sorted"

  edge_cases:
    - "Fresh install: Balance = 60, Activity empty, HealthKit prompt appears"
    - "Deny HealthKit: App works, can only spend, cannot earn"
    - "No blocked apps selected: No spend transactions, earning still works"
    - "0-duration workout in Health: No transaction created"

# ═══════════════════════════════════════════════════════════════════
# OUT OF SCOPE
# ═══════════════════════════════════════════════════════════════════

out_of_scope:
  - Onboarding flow changes
  - Settings screen
  - Notifications ("5 min remaining", "workout synced")
  - Difficulty-based starting balance (stays at 60 for all difficulties)
  - Historical workout import (only workouts after app install)
  - Apple Watch companion

dependencies:
  - "Ticket 003 (App Blocking) - COMPLETED"
